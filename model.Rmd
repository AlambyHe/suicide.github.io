---
title: "Model"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # general
library(ggalt) # dumbbell plots
library(countrycode) # continent
library(rworldmap) # quick country-level heat maps
library(gridExtra) # plots
library(broom) # significant trends within countries
theme_set(theme_light())
library(plyr)
library(dplyr)
library(lubridate)
library(caTools)
library(ggplot2)
library(ggthemes)
library(reshape2)
library(data.table)
library(tidyr)
library(corrgram)       
library(corrplot)
library(formattable)
library(cowplot)
library(ggpubr)
library(plot3D)
```

Suicide rate chages with year

```{r, message=FALSE, warning=FALSE}
suicide <- read_csv("./data/master.csv") %>% 
  janitor::clean_names() %>%
  as.data.frame() 

suicide = suicide %>% 
  mutate(
    continent = countrycode(sourcevar = suicide[, "country"],
                              origin = "country.name",
                              destination = "continent")
  )


country_year <- suicide %>%
  group_by(country, year, continent) %>%
  dplyr::summarize(suicides = sum(suicides_no), 
            population = sum(population), 
            suicide_per_100k = (suicides / population) * 100000, 
            gdp_per_capita = mean(gdp_per_capita),
            gdp_for_year = mean(gdp_for_year))

country_year_trends <- country_year %>%
  ungroup() %>%
  nest(-country) %>% # format: country, rest of data (in list column)
  mutate(model = map(data, ~ lm(suicide_per_100k ~ year, data = .)), # for each item in 'data', fit a linear model
         tidied = map(model, tidy)) %>% # tidy each of these into dataframe format - call this list 'tidied'
  unnest(tidied)

country_year_sig_trends <- country_year_trends %>%
  filter(term == "year") %>%
  mutate(p.adjusted = p.adjust(p.value, method = "holm")) %>%
  filter(p.adjusted < .05) %>%
  arrange(estimate)

country_year_sig_trends$country <- factor(country_year_sig_trends$country, 
                                          ordered = T, 
                                          levels = country_year_sig_trends$country)
ggplot(country_year_sig_trends, aes(x=country, y=estimate, col = estimate)) + 
  geom_point(stat='identity', size = 4) +
  geom_hline(yintercept = 0, col = "grey", size = 1) +
  scale_color_gradient(low = "green", high = "red") +
  geom_segment(aes(y = 0, 
                   x = country, 
                   yend = estimate, 
                   xend = country), size = 1) +
  labs(title="Change per year (Suicides per 100k)", 
       subtitle="Of countries with significant trends (p < 0.05)", 
       x = "Country", y = "Change Per Year (Suicides per 100k)") +
  scale_y_continuous(breaks = seq(-2, 2, 0.2), limits = c(-1.5, 1.5)) +
  theme(legend.position = "none") +
  coord_flip()
```

The relationship between suicide rate and gdp_per_capita

```{r}
ggplot(country_year, aes(x = gdp_per_capita, y = suicide_per_100k, col = continent)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  scale_x_continuous(labels=scales::dollar_format(prefix="$"), breaks = seq(0, 125000, 10000)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(~continent)
```


Happiness score are related to ?

```{r, message=FALSE, warning=FALSE}
## clean the data
happiness_2015 <- read_csv("./data/2015.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2015
  ) %>% 
  select(-region, -standard_error)
happiness_2016 <- read_csv("./data/2016.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2016
  ) %>% 
  select(-region, -lower_confidence_interval, -upper_confidence_interval)
happiness_2017 <- read_csv("./data/2017.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2017
  ) %>% 
  select(-whisker_high, -whisker_low) 

happiness_2015 = happiness_2015[, c(1,11,2,3,4,5,6,7,8,9,10)]
happiness_2016 = happiness_2016[, c(1,11,2,3,4,5,6,7,8,9,10)]
happiness_2017 = happiness_2017[, c(1,11,2,3,4,5,6,7,9,8,10)]
happiness = rbind(happiness_2015, happiness_2016, happiness_2017)

## generate correlation plot
happiness_2015_cor = happiness_2015 %>% select(-year)
happiness_2016_cor = happiness_2016 %>% select(-year)
happiness_2017_cor = happiness_2017 %>% select(-year)
Num.cols_2015 <- sapply(happiness_2015_cor, is.numeric)
Num.cols_2016 <- sapply(happiness_2016_cor, is.numeric)
Num.cols_2017 <- sapply(happiness_2017_cor, is.numeric)
Cor.data_2015 <- cor(happiness_2015_cor[, Num.cols_2015])
Cor.data_2016 <- cor(happiness_2016_cor[, Num.cols_2016])
Cor.data_2017 <- cor(happiness_2017_cor[, Num.cols_2017])

corrplot(Cor.data_2015, method = 'square', addCoef.col = "black", tl.col ="black", tl.srt=45, diag = FALSE, number.cex = .7, title = "correlation between happiness and other variables in 2015") 
corrplot(Cor.data_2016, method = 'square', addCoef.col = "black", tl.col ="black", tl.srt=45, diag = FALSE, number.cex = .7, title = "correlation between happiness and other variables in 2016")  
corrplot(Cor.data_2017, method = 'square', addCoef.col = "black", tl.col ="black", tl.srt=45, diag = FALSE, number.cex = .7, title = "correlation between happiness and other variables in 2017")  


```




